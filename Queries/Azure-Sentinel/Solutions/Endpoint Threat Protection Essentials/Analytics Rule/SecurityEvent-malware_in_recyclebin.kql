let recycle_bin_paths = dynamic([@":\RECYCLER", @":\$RECYCLE.BIN"]);
let lolbas_filenames = toscalar(
    externaldata(
        Filename:string//,
        // Description:string,
        // Author:string,
        // Date:datetime,
        // Command:string,
        // CommandDescription:string,
        // CommandUsecase:string,
        // CommandCategory:string,
        // CommandPrivileges:string,
        // Technique:string,
        // OperatingSystem:string,
        // Paths:string,
        // Detections:string,
        // Resources:string,
        // Acknowledgements:string,
        // URL:string
    ) [@"https://lolbas-project.github.io/api/lolbas.csv"] with (format="csv", ignoreFirstRecord=True)
    | summarize make_set(Filename)
);
union
    (SecurityEvent
    | where EventID == 4688
    | where (CommandLine has_any (recycle_bin_paths) and CommandLine has_any (lolbas_filenames))
        or  (NewProcessName has_any (recycle_bin_paths) and Process has_any (lolbas_filenames))
    | project TimeGenerated, Computer, Account, AccountType, SubjectLogonId, TargetAccount, Activity, ParentProcessName, NewProcessName, CommandLine
    ),
    (SecurityEvent
    | where EventID == 4663
    | where ObjectName has_any (recycle_bin_paths) and ObjectName has_any (lolbas_filenames)
    | project TimeGenerated, Computer, Account, AccountType, SubjectLogonId, TargetAccount, Activity, ObjectType, ObjectName, EventData
    )
