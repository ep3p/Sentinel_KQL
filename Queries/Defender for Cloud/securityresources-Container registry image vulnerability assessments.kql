// Use here: https://portal.azure.com/#view/HubsExtension/ArgQueryBlade
securityresources
| where type =~ "microsoft.security/assessments/subassessments" and id has "providers/Microsoft.ContainerRegistry/registries/"
    //and subscriptionId == ""
| extend
    timeGenerated = todatetime(properties["timeGenerated"]),
    description = tostring(properties["description"]),
    status = tostring(properties["status"]["code"]),
    severity = tostring(properties["status"]["severity"]),
    resourceId = tostring(properties["resourceDetails"]["id"]),
    assessedResourceType = tostring(properties["additionalData"]["assessedResourceType"]),
    assessmentType = tostring(properties["additionalData"]["type"]),
    registryHost = tostring(properties["additionalData"]["registryHost"]),
    repositoryName = tostring(properties["additionalData"]["repositoryName"]),
    imageDigest = tostring(properties["additionalData"]["imageDigest"]),
    scanner = tostring(properties["additionalData"]["scanner"]),
    cve = properties["additionalData"]["cve"],
    id = toint(properties["id"])
| mv-expand cve = iff(array_length(cve) == 0, dynamic([""]), cve)
| extend cve = tostring(cve["title"])
| summarize arg_max(timeGenerated, *) by assessedResourceType, assessmentType, registryHost, repositoryName, imageDigest, scanner, cve, id
| summarize
    //Scanners = make_set(scanner),
    Vulnerabilities = make_list(pack("CVE", cve, "Description", description, "Severity", severity, "Id", id))
    by type, tenantId, subscriptionId, resourceGroup, location, resourceId, assessedResourceType, assessmentType, registryHost, repositoryName, imageDigest, status
| sort by tenantId asc, subscriptionId asc, status asc, resourceId asc
| project
    type,
    tenantId,
    subscriptionId,
    resourceGroup,
    location,
    resourceId,
    assessedResourceType,
    assessmentType,
    registryHost,
    repositoryName,
    imageDigest,
    status,
    //Scanners,
    Vulnerabilities
